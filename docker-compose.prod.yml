services:
  prediction_app:
    image: finai-cn-shanghai.cr.volces.com/default/fina-demo-prediction-app:latest
    environment:
      PORT: "5703"
      # Database configuration (Aliyun RDS PostgreSQL)
      DB_HOST: ${DB_HOST:-pgm-uf615169n98t95tflo.pg.rds.aliyuncs.com}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-postgres}
      DB_USER: ${DB_USER:-postgres_fuli}
      DB_PASSWORD: ${DB_PASSWORD:-jfd4whz@GPF2nqx7zhm}
      # Optional (only required if you want AI explanations/insights).
      VOLCENGINE_API_KEY2: ${VOLCENGINE_API_KEY2:-a0533576-d6ed-4ca4-a308-473cbf7ebd10}
      VOLCENGINE_API_URL: ${VOLCENGINE_API_URL:-https://ark.cn-beijing.volces.com/api/v3}
      VOLCENGINE_MODEL: ${VOLCENGINE_MODEL:-kimi-k2-250905}
      # AI API timeout configuration (in seconds)
      RFM_AI_TIMEOUT_SECONDS: ${RFM_AI_TIMEOUT_SECONDS:-300}
      SEGMENTATION_AI_TIMEOUT_SECONDS: ${SEGMENTATION_AI_TIMEOUT_SECONDS:-300}
      STOCK_ALLOC_AI_TIMEOUT_SECONDS: ${STOCK_ALLOC_AI_TIMEOUT_SECONDS:-300}
    volumes:
      - ./uploads:/app/uploads
    ports:
      # Only bind to localhost, access via nginx reverse proxy
      - "127.0.0.1:5703:5703"
    restart: unless-stopped

  agent:
    image: finai-cn-shanghai.cr.volces.com/default/fina-demo-agent:latest
    environment:
      TZ: Asia/Shanghai
      NODE_ENV: production
      PORT: "5702"
      PYTHON_API_URL: http://prediction_app:5703
      UPLOAD_DIR: /app/uploads
      # Database configuration (for dataset queries - Aliyun RDS PostgreSQL)
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres_fuli:jfd4whz@GPF2nqx7zhm@pgm-uf615169n98t95tflo.pg.rds.aliyuncs.com:5432/postgres}
      DB_HOST: ${DB_HOST:-pgm-uf615169n98t95tflo.pg.rds.aliyuncs.com}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-postgres}
      DB_USER: ${DB_USER:-postgres_fuli}
      DB_PASSWORD: ${DB_PASSWORD:-jfd4whz@GPF2nqx7zhm}
      # Optional (LLM provider for the agent + some Python insight endpoints).
      VOLCENGINE_API_KEY2: ${VOLCENGINE_API_KEY2:-a0533576-d6ed-4ca4-a308-473cbf7ebd10}
      VOLCENGINE_API_URL: ${VOLCENGINE_API_URL:-https://ark.cn-beijing.volces.com/api/v3}
      VOLCENGINE_MODEL: ${VOLCENGINE_MODEL:-kimi-k2-250905}
      # RTC / Voice Chat configuration (Volcengine RTC)
      # These should be set via environment variables or .env file
      VOLCENGINE_APP_ID: ${VOLCENGINE_APP_ID}
      VOLCENGINE_APP_KEY: ${VOLCENGINE_APP_KEY}
      VOLC_RTC_API_URL: ${VOLC_RTC_API_URL:-https://rtc.volcengineapi.com}
      VOLC_REGION: ${VOLC_REGION:-cn-north-1}
      VOLC_ACCESSKEY: ${VOLC_ACCESSKEY}
      VOLC_SECRETKEY: ${VOLC_SECRETKEY}
      # Speech (ASR/TTS) configuration
      VOLC_SPEECH_APP_ID: ${VOLC_SPEECH_APP_ID}
      VOLC_SPEECH_ACCESS_TOKEN: ${VOLC_SPEECH_ACCESS_TOKEN}
      VOLC_SPEECH_SECRET_KEY: ${VOLC_SPEECH_SECRET_KEY}
      VOLC_TTS_CLUSTER: ${VOLC_TTS_CLUSTER:-volcano_tts}
      # Coze Bot configuration (for LLM in voice chat)
      COZEBOT_APIKEY: ${COZEBOT_APIKEY}
    volumes:
      - ./uploads:/app/uploads
      - ./lattice_store:/app/lattice_store

      # Mount datasets config so agent can access it
      - ./prediction_app/config:/app/prediction_app/config:ro
    depends_on:
      - prediction_app
    ports:
      # Only bind to localhost, access via nginx reverse proxy
      - "127.0.0.1:5702:5702"
    restart: unless-stopped

  ai_web:
    image: finai-cn-shanghai.cr.volces.com/default/fina-demo-ai-web:latest
    depends_on:
      - agent
    ports:
      # Only bind to localhost, access via nginx reverse proxy
      - "127.0.0.1:5701:5701"
    restart: unless-stopped
